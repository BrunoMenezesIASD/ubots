<div class="container">
  <div class="grid kpis" *ngIf="summary as s">
    <app-kpi-card title="NEW" [value]="s.totalByStatus['NEW'] ?? 0"></app-kpi-card>
    <app-kpi-card title="QUEUED" [value]="s.totalByStatus['QUEUED'] ?? 0"></app-kpi-card>
    <app-kpi-card title="ASSIGNED" [value]="s.totalByStatus['ASSIGNED'] ?? 0"></app-kpi-card>
    <app-kpi-card title="DONE" [value]="s.totalByStatus['DONE'] ?? 0"></app-kpi-card>

    <app-kpi-card title="Fila Cartões" [value]="s.queueSizeByTeam['CARTOES'] ?? 0"></app-kpi-card>
    <app-kpi-card title="Fila Empréstimos" [value]="s.queueSizeByTeam['EMPRESTIMOS'] ?? 0"></app-kpi-card>
    <app-kpi-card title="Fila Outros" [value]="s.queueSizeByTeam['OUTROS'] ?? 0"></app-kpi-card>
  </div>

  <mat-card style="margin-top:16px; border-radius: 16px;">
    <mat-card-title>Atendimentos</mat-card-title>
    <mat-card-content>
      <div class="filters">
        <mat-form-field appearance="outline">
          <mat-label>Team</mat-label>
          <mat-select [formControl]="teamCtrl" (selectionChange)="loadRequests()">
            <mat-option value="">(todos)</mat-option>
            <mat-option value="CARTOES">CARTOES</mat-option>
            <mat-option value="EMPRESTIMOS">EMPRESTIMOS</mat-option>
            <mat-option value="OUTROS">OUTROS</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [formControl]="statusCtrl" (selectionChange)="loadRequests()">
            <mat-option value="">(todos)</mat-option>
            <mat-option value="NEW">NEW</mat-option>
            <mat-option value="QUEUED">QUEUED</mat-option>
            <mat-option value="ASSIGNED">ASSIGNED</mat-option>
            <mat-option value="DONE">DONE</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="loadRequests()">Atualizar</button>
      </div>

      <table mat-table [dataSource]="requests" class="mat-elevation-z1">
        <ng-container matColumnDef="id"><th mat-header-cell *matHeaderCellDef>Id</th><td mat-cell *matCellDef="let r">{{r.id}}</td></ng-container>
        <ng-container matColumnDef="customerName"><th mat-header-cell *matHeaderCellDef>Cliente</th><td mat-cell *matCellDef="let r">{{r.customerName}}</td></ng-container>
        <ng-container matColumnDef="subject"><th mat-header-cell *matHeaderCellDef>Assunto</th><td mat-cell *matCellDef="let r">{{r.subject}}</td></ng-container>
        <ng-container matColumnDef="team"><th mat-header-cell *matHeaderCellDef>Team</th><td mat-cell *matCellDef="let r">{{r.team}}</td></ng-container>
        <ng-container matColumnDef="status"><th mat-header-cell *matHeaderCellDef>Status</th><td mat-cell *matCellDef="let r">{{r.status}}</td></ng-container>
        <ng-container matColumnDef="assignedAttendantId"><th mat-header-cell *matHeaderCellDef>Atendente</th><td mat-cell *matCellDef="let r">{{r.assignedAttendantId}}</td></ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Ações</th>
          <td mat-cell *matCellDef="let r">
            <button mat-button color="primary" (click)="finishRequest(r.id)" [disabled]="r.status !== 'ASSIGNED'">Finalizar</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedRequestsColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedRequestsColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <mat-card style="margin-top:16px; border-radius: 16px;">
    <mat-card-title>Atendentes</mat-card-title>
    <mat-card-content>
      <table mat-table [dataSource]="attendants" class="mat-elevation-z1">
        <ng-container matColumnDef="id"><th mat-header-cell *matHeaderCellDef>Id</th><td mat-cell *matCellDef="let a">{{a.id}}</td></ng-container>
        <ng-container matColumnDef="name"><th mat-header-cell *matHeaderCellDef>Nome</th><td mat-cell *matCellDef="let a">{{a.name}}</td></ng-container>
        <ng-container matColumnDef="team"><th mat-header-cell *matHeaderCellDef>Team</th><td mat-cell *matCellDef="let a">{{a.team}}</td></ng-container>
        <ng-container matColumnDef="active"><th mat-header-cell *matHeaderCellDef>Ativo</th><td mat-cell *matCellDef="let a">{{a.active}}</td></ng-container>
        <ng-container matColumnDef="activeAssignments"><th mat-header-cell *matHeaderCellDef>Ativos</th><td mat-cell *matCellDef="let a">{{a.activeAssignments}}</td></ng-container>
        <ng-container matColumnDef="remainingCapacity"><th mat-header-cell *matHeaderCellDef>Restante</th><td mat-cell *matCellDef="let a">{{a.remainingCapacity}}</td></ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Ações</th>
          <td mat-cell *matCellDef="let a">
            <button mat-button (click)="toggleAttendant(a)">{{a.active ? 'Desativar' : 'Ativar'}}</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedAttendantsColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedAttendantsColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
